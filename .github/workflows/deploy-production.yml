name: Deploy to Production

on:
  workflow_dispatch:  # Manual trigger only
  workflow_run:
    workflows: ["Backend Tests", "Frontend Tests & Build", "Build & Push Backend Docker Image", "Build & Push Frontend Docker Image"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.ref == 'refs/heads/main') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Summary
        run: |
          echo "âœ… All CI/CD checks passed!"
          echo "ðŸ“¦ Ready for deployment"
          echo ""
          echo "**Deployment Information:**"
          echo "- Repository: ${{ github.repository }}"
          echo "- Branch: ${{ github.ref }}"
          echo "- Commit: ${{ github.sha }}"
          echo "- Author: ${{ github.actor }}"
          echo ""
          echo "**Docker Images Built:**"
          echo "- ghcr.io/${{ github.repository_owner }}/tradeflow-api:latest"
          echo "- ghcr.io/${{ github.repository_owner }}/tradeflow-web:latest"
          echo ""
          echo "**To Deploy to Your VPS:**"
          echo "1. SSH into your VPS"
          echo "2. Run the following commands:"
          echo ""
          echo "   cd /opt/tradeflow-os"
          echo "   git pull origin main"
          echo "   docker compose pull"
          echo "   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d"
          echo "   sleep 10"
          echo "   docker compose exec api alembic upgrade head"
          echo "   docker compose ps"
          echo ""
          echo "**For Automated Deployment:**"
          echo "Set these GitHub Secrets:"
          echo "- VPS_HOST: Your VPS IP or hostname"
          echo "- VPS_USER: SSH username (ec2-user, ubuntu, etc.)"
          echo "- VPS_SSH_KEY: Private SSH key"
          echo ""
          echo "Then uncomment the SSH deployment step in this workflow"
